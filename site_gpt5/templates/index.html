<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Skymarshal â€” Simple Stats</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 0; }
      header { padding: 20px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 12px; }
      main { max-width: 960px; margin: 0 auto; padding: 24px; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; }
      .col { flex: 1 1 220px; }
      input, button { font-size: 16px; padding: 10px 12px; border-radius: 8px; border: 1px solid #ccc; }
      button { cursor: pointer; border-color: #888; background: #0ea5e9; color: white; }
      button.secondary { background: #64748b; }
      .hidden { display: none; }
      .error { color: #dc2626; }
      .muted { color: #6b7280; }
      .stat { font-size: 28px; font-weight: 700; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap: 12px; }
    </style>
  </head>
  <body>
    <header>
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Blue_Sky_%28Unsplash%29.jpg" width="44" height="44" style="border-radius: 8px; object-fit: cover" alt="" />
      <div>
        <div style="font-weight: 700">Skymarshal â€” Simple Stats</div>
        <div class="muted">Authenticate â†’ Download CAR â†’ Process â†’ View stats</div>
      </div>
    </header>
    <main>
      <!-- Login card -->
      <div class="card {{ 'hidden' if logged_in else '' }}" id="loginCard">
        <h3>Login to Bluesky</h3>
        <p class="muted">Use your handle and an app password (from Bluesky settings).</p>
        <div class="row">
          <div class="col">
            <input id="handle" placeholder="@yourname or yourname.bsky.social" />
          </div>
          <div class="col">
            <input id="password" placeholder="App password (xxxx-xxxx-xxxx-xxxx)" type="password" />
          </div>
          <div class="col" style="flex: 0 0 auto">
            <button id="loginBtn">Login</button>
          </div>
        </div>
        <div id="loginError" class="error"></div>
      </div>

      <!-- Action card for authenticated session -->
      <div class="card {{ '' if logged_in else 'hidden' }}" id="actionsCard">
        <div class="row" style="align-items:center; justify-content: space-between">
          <h3 style="margin:0">Welcome, <span id="who">{{ handle or '' }}</span></h3>
          <button id="logoutBtn" class="secondary" title="Logout">Logout</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="downloadBtn">1) Download CAR</button>
          <button id="processBtn" class="secondary">2) Process + Enrich</button>
          <button id="refreshBtn" class="secondary">Refresh Stats</button>
        </div>
        <div id="actionStatus" class="muted"></div>
        
        <!-- Background CAR Download Status -->
        <div class="card hidden" id="carDownloadCard" style="margin-top:10px; border-color:#0ea5e9;">
          <div class="row" style="align-items:center; justify-content:space-between">
            <div>
              <div style="font-weight:600">ðŸ“¦ CAR File Backup</div>
              <div id="carDownloadStatus" class="muted">Preparing backup...</div>
            </div>
            <button id="downloadCarBtn" class="secondary hidden" disabled>Download Backup</button>
          </div>
          <div id="carDownloadProgress" class="hidden" style="margin-top:8px;">
            <div style="background:#f0f0f0; border-radius:4px; height:8px; overflow:hidden;">
              <div id="carProgressBar" style="background:#0ea5e9; height:100%; width:0%; transition:width 0.3s;"></div>
            </div>
            <div id="carProgressText" class="muted" style="font-size:12px; margin-top:4px;">0%</div>
          </div>
        </div>

        <!-- Hydration Progress Status -->
        <div class="card hidden" id="hydrationCard" style="margin-top:10px; border-color:#10b981;">
          <div class="row" style="align-items:center; justify-content:space-between">
            <div>
              <div style="font-weight:600">ðŸ”„ Engagement Hydration</div>
              <div id="hydrationStatus" class="muted">Processing engagement data...</div>
            </div>
          </div>
          <div id="hydrationProgress" class="hidden" style="margin-top:8px;">
            <div style="background:#f0f0f0; border-radius:4px; height:8px; overflow:hidden;">
              <div id="hydrationProgressBar" style="background:#10b981; height:100%; width:0%; transition:width 0.3s;"></div>
            </div>
            <div id="hydrationProgressText" class="muted" style="font-size:12px; margin-top:4px;">0%</div>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="card {{ '' if stats else 'hidden' }}" id="statsCard">
        <h3>Statistics</h3>
        <div id="statsEmpty" class="muted">No stats yet. Complete steps above.</div>
        <div id="statsGrid" class="grid hidden">
          <div class="card">
            <div class="muted">Posts</div>
            <div class="stat" id="statPosts">0</div>
          </div>
          <div class="card">
            <div class="muted">Total items</div>
            <div class="stat" id="statTotal">0</div>
          </div>
          <div class="card">
            <div class="muted">Avg engagement (posts)</div>
            <div class="stat" id="statAvgEng">0</div>
          </div>
          <div class="card">
            <div class="muted">Engagement total</div>
            <div class="stat" id="statEngTotal">0</div>
          </div>
          <div class="card">
            <div class="muted">Likes received</div>
            <div class="stat" id="statLikesReceived">0</div>
          </div>
          <div class="card">
            <div class="muted">Reposts received</div>
            <div class="stat" id="statRepostsReceived">0</div>
          </div>
          <div class="card">
            <div class="muted">Replies received</div>
            <div class="stat" id="statRepliesReceived">0</div>
          </div>
          <div class="card">
            <div class="muted">Quotes received</div>
            <div class="stat" id="statQuotesReceived">0</div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const $ = (id) => document.getElementById(id);

      async function post(url, payload) {
        const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload||{}) });
        const j = await r.json().catch(() => ({}));
        if (!r.ok || j.success === false) throw new Error(j.error || 'Request failed');
        return j;
      }

      function renderStats(stats) {
        if (!stats) { $('statsEmpty').classList.remove('hidden'); $('statsGrid').classList.add('hidden'); return; }
        $('statsEmpty').classList.add('hidden');
        $('statsGrid').classList.remove('hidden');
        $('statPosts').innerText   = stats.counts.posts;
        $('statTotal').innerText   = stats.counts.total_items;
        $('statAvgEng').innerText  = stats.engagement.avg_engagement;
        $('statEngTotal').innerText= stats.engagement.total_engagement;
        $('statLikesReceived').innerText   = stats.engagement.likes_received;
        $('statRepostsReceived').innerText = stats.engagement.reposts_received;
        $('statRepliesReceived').innerText = stats.engagement.replies_received;
        $('statQuotesReceived').innerText  = stats.engagement.quotes_received;
      }

      // Event wiring
      const loginBtn = $('loginBtn');
      if (loginBtn) loginBtn.onclick = async () => {
        $('loginError').innerText = '';
        try {
          const res = await post('/login', { handle: $('handle').value, password: $('password').value });
          location.reload();
        } catch (e) {
          $('loginError').innerText = e.message;
        }
      };

      const downloadBtn = $('downloadBtn');
      if (downloadBtn) downloadBtn.onclick = async () => {
        $('actionStatus').innerText = 'Starting CAR download...';
        try {
          const res = await post('/download');
          $('actionStatus').innerText = 'CAR download started in background.';
          
          // Show background download card
          $('carDownloadCard').classList.remove('hidden');
          $('carDownloadProgress').classList.remove('hidden');
          
          // Start monitoring background download
          startCarDownloadMonitoring();
          
        } catch (e) {
          $('actionStatus').innerText = 'Download failed: ' + e.message;
        }
      };

      const processBtn = $('processBtn');
      if (processBtn) processBtn.onclick = async () => {
        $('actionStatus').innerText = 'Processing and enriching...';
        
        // Show hydration progress card
        $('hydrationCard').classList.remove('hidden');
        $('hydrationProgress').classList.remove('hidden');
        
        // Start monitoring hydration progress
        startHydrationMonitoring();
        
        try {
          const res = await post('/process');
          $('actionStatus').innerText = 'Processed.';
          renderStats(res.stats);
        } catch (e) {
          $('actionStatus').innerText = 'Processing failed: ' + e.message;
          // Stop monitoring on error
          stopHydrationMonitoring();
          updateHydrationUI({ status: 'failed', progress: { message: 'Processing failed: ' + e.message } });
        }
      };

      const refreshBtn = $('refreshBtn');
      if (refreshBtn) refreshBtn.onclick = async () => {
        $('actionStatus').innerText = 'Refreshing engagement data...';
        
        // Show hydration progress card
        $('hydrationCard').classList.remove('hidden');
        $('hydrationProgress').classList.remove('hidden');
        
        // Start monitoring hydration progress
        startHydrationMonitoring();
        
        try {
          const res = await post('/refresh-engagement');
          $('actionStatus').innerText = res.message || 'Refreshed engagement data.';
          // Reload to show updated stats
          setTimeout(() => location.reload(), 1000);
        } catch (e) {
          $('actionStatus').innerText = 'Refresh failed: ' + e.message;
          stopHydrationMonitoring();
          updateHydrationUI({ status: 'failed', progress: { message: 'Refresh failed: ' + e.message } });
        }
      };

      const logoutBtn = $('logoutBtn');
      if (logoutBtn) logoutBtn.onclick = async () => {
        try {
          await fetch('/logout', { method: 'POST' });
        } catch (e) {}
        location.href = '/';
      };

      // CAR Download monitoring functions
      let carDownloadInterval = null;
      
      function startCarDownloadMonitoring() {
        if (carDownloadInterval) clearInterval(carDownloadInterval);
        
        carDownloadInterval = setInterval(async () => {
          try {
            const response = await fetch('/car-download-status');
            const data = await response.json();
            
            if (data.success) {
              updateCarDownloadUI(data);
              
              // Stop monitoring if completed or failed
              if (data.status === 'completed' || data.status === 'failed') {
                clearInterval(carDownloadInterval);
                carDownloadInterval = null;
              }
            }
          } catch (e) {
            console.error('Failed to check CAR download status:', e);
          }
        }, 1000); // Check every second
      }
      
      function updateCarDownloadUI(data) {
        const statusEl = $('carDownloadStatus');
        const progressEl = $('carProgressBar');
        const progressTextEl = $('carProgressText');
        const downloadBtnEl = $('downloadCarBtn');
        
        switch (data.status) {
          case 'running':
            statusEl.innerText = data.progress.message || 'Downloading CAR file...';
            progressEl.style.width = data.progress.percentage + '%';
            progressTextEl.innerText = Math.round(data.progress.percentage) + '%';
            break;
            
          case 'completed':
            statusEl.innerText = `CAR backup ready! (${formatFileSize(data.file_size)})`;
            progressEl.style.width = '100%';
            progressTextEl.innerText = '100%';
            
            // Show download button
            downloadBtnEl.classList.remove('hidden');
            downloadBtnEl.disabled = false;
            downloadBtnEl.onclick = () => {
              const url = data.download_url || `/download-car?handle=${encodeURIComponent('{{ handle or "" }}')}`;
              window.location.href = url;
            };
            break;
            
          case 'failed':
            statusEl.innerText = 'CAR backup failed';
            progressEl.style.width = '0%';
            progressEl.style.background = '#dc2626';
            progressTextEl.innerText = 'Error';
            break;
            
          default:
            statusEl.innerText = 'Preparing CAR backup...';
        }
      }
      
      function formatFileSize(bytes) {
        if (!bytes) return '';
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
      }

      // Hydration monitoring functions
      let hydrationInterval = null;
      
      function startHydrationMonitoring() {
        if (hydrationInterval) clearInterval(hydrationInterval);
        
        hydrationInterval = setInterval(async () => {
          try {
            const response = await fetch('/hydration-status');
            const data = await response.json();
            
            if (data.success) {
              updateHydrationUI(data);
              
              // Stop monitoring if completed or failed
              if (data.status === 'completed' || data.status === 'failed') {
                stopHydrationMonitoring();
              }
            }
          } catch (e) {
            console.error('Failed to check hydration status:', e);
          }
        }, 500); // Check every 500ms for faster updates
      }
      
      function stopHydrationMonitoring() {
        if (hydrationInterval) {
          clearInterval(hydrationInterval);
          hydrationInterval = null;
        }
      }
      
      function updateHydrationUI(data) {
        const statusEl = $('hydrationStatus');
        const progressEl = $('hydrationProgressBar');
        const progressTextEl = $('hydrationProgressText');
        
        switch (data.status) {
          case 'running':
            statusEl.innerText = data.progress.message || 'Processing engagement data...';
            progressEl.style.width = data.progress.percentage + '%';
            progressEl.style.background = '#10b981';
            progressTextEl.innerText = Math.round(data.progress.percentage) + '%';
            break;
            
          case 'completed':
            statusEl.innerText = data.progress.message || 'Engagement hydration completed!';
            progressEl.style.width = '100%';
            progressEl.style.background = '#10b981';
            progressTextEl.innerText = '100%';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
              $('hydrationCard').classList.add('hidden');
            }, 5000);
            break;
            
          case 'failed':
            statusEl.innerText = data.progress.message || 'Engagement hydration failed';
            progressEl.style.width = '0%';
            progressEl.style.background = '#dc2626';
            progressTextEl.innerText = 'Error';
            break;
            
          default:
            statusEl.innerText = 'Preparing engagement hydration...';
        }
      }

      // Check for existing CAR download on page load
      if ({{ 'true' if logged_in else 'false' }}) {
        fetch('/car-download-status')
          .then(r => r.json())
          .then(data => {
            if (data.success && data.status !== 'none') {
              $('carDownloadCard').classList.remove('hidden');
              $('carDownloadProgress').classList.remove('hidden');
              updateCarDownloadUI(data);
              
              if (data.status === 'running') {
                startCarDownloadMonitoring();
              }
            }
          })
          .catch(e => console.error('Failed to check initial CAR status:', e));
      }

      // Initial render injected by server
      const initialStats = {{ stats | tojson | safe if stats else 'null' }};
      if (initialStats) renderStats(initialStats);
    </script>
  </body>
</html>
