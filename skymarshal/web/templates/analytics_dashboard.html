{% extends "base.html" %}

{% block title %}Analytics Dashboard - Skymarshal{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Analytics Dashboard</h1>
            <p class="lead">Comprehensive analytics tools for your Bluesky content and social relationships.</p>
        </div>
    </div>

    <!-- Analytics Tools Grid -->
    <div class="row">
        <!-- Follower Analysis Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users"></i> Follower Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Analyze your followers with ranking, bot detection, and quality assessment.</p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success"></i> Follower ranking by engagement</li>
                        <li><i class="fas fa-check text-success"></i> Bot detection algorithms</li>
                        <li><i class="fas fa-check text-success"></i> Quality follower analysis</li>
                        <li><i class="fas fa-check text-success"></i> Smart caching system</li>
                    </ul>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary w-100" onclick="startFollowerAnalysis()">
                        <i class="fas fa-play"></i> Start Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Post Analysis Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line"></i> Post Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Analyze your posts with engagement metrics and performance insights.</p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success"></i> Post ranking by engagement</li>
                        <li><i class="fas fa-check text-success"></i> Engagement pattern analysis</li>
                        <li><i class="fas fa-check text-success"></i> Performance metrics</li>
                        <li><i class="fas fa-check text-success"></i> Parallel processing</li>
                    </ul>
                </div>
                <div class="card-footer">
                    <button class="btn btn-success w-100" onclick="startPostAnalysis()">
                        <i class="fas fa-play"></i> Start Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Analysis Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-brain"></i> Content Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">LLM-powered content analysis with vibe checking and sentiment analysis.</p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success"></i> LLM-powered vibe checking</li>
                        <li><i class="fas fa-check text-success"></i> Sentiment analysis</li>
                        <li><i class="fas fa-check text-success"></i> Content categorization</li>
                        <li><i class="fas fa-check text-success"></i> Theme extraction</li>
                    </ul>
                </div>
                <div class="card-footer">
                    <button class="btn btn-info w-100" onclick="startContentAnalysis()">
                        <i class="fas fa-play"></i> Start Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Results Section -->
    <div class="row mt-4" id="results-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Analysis Results</h5>
                </div>
                <div class="card-body">
                    <div id="analysis-results">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Analysis in Progress</h5>
                    <p class="mb-0">Please wait while we analyze your data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Analytics functions
function startFollowerAnalysis() {
    showLoadingModal();
    
    fetch('/skymarshal/analytics/followers', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'analyze',
            max_followers: 100
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingModal();
        if (data.success) {
            displayFollowerResults(data.results);
        } else {
            showError(data.error || 'Follower analysis failed');
        }
    })
    .catch(error => {
        hideLoadingModal();
        showError('Network error: ' + error.message);
    });
}

function startPostAnalysis() {
    showLoadingModal();
    
    fetch('/skymarshal/analytics/posts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'analyze',
            max_posts: 100
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingModal();
        if (data.success) {
            displayPostResults(data.results);
        } else {
            showError(data.error || 'Post analysis failed');
        }
    })
    .catch(error => {
        hideLoadingModal();
        showError('Network error: ' + error.message);
    });
}

function startContentAnalysis() {
    showLoadingModal();
    
    fetch('/skymarshal/analytics/content', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'analyze',
            analysis_types: ['vibe', 'summary', 'sentiment', 'categorize']
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingModal();
        if (data.success) {
            displayContentResults(data.results);
        } else {
            showError(data.error || 'Content analysis failed');
        }
    })
    .catch(error => {
        hideLoadingModal();
        showError('Network error: ' + error.message);
    });
}

function displayFollowerResults(results) {
    const resultsDiv = document.getElementById('analysis-results');
    resultsDiv.innerHTML = `
        <h6>Follower Analysis Results</h6>
        <p><strong>Total Followers Analyzed:</strong> ${results.total_followers}</p>
        <p><strong>High Bot Score (>0.7):</strong> ${results.bot_analysis.filter(f => f.bot_score > 0.7).length}</p>
        <p><strong>High Quality (>0.7):</strong> ${results.quality_analysis.filter(f => f.quality_score > 0.7).length}</p>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <h6>Top Followers by Follower Count</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Handle</th>
                                <th>Followers</th>
                                <th>Following</th>
                                <th>Ratio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.ranked_followers.slice(0, 10).map(follower => `
                                <tr>
                                    <td>@${follower.handle}</td>
                                    <td>${follower.followersCount.toLocaleString()}</td>
                                    <td>${follower.followsCount.toLocaleString()}</td>
                                    <td>${follower.followsCount > 0 ? (follower.followersCount / follower.followsCount).toFixed(2) : 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-6">
                <h6>Bot Analysis (Top 10)</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Handle</th>
                                <th>Bot Score</th>
                                <th>Quality</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.bot_analysis.slice(0, 10).map(follower => `
                                <tr>
                                    <td>@${follower.handle}</td>
                                    <td><span class="badge ${follower.bot_score > 0.7 ? 'bg-danger' : follower.bot_score > 0.4 ? 'bg-warning' : 'bg-success'}">${follower.bot_score.toFixed(2)}</span></td>
                                    <td>${follower.quality_score.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('results-section').style.display = 'block';
}

function displayPostResults(results) {
    const resultsDiv = document.getElementById('analysis-results');
    resultsDiv.innerHTML = `
        <h6>Post Analysis Results</h6>
        <p><strong>Total Posts Analyzed:</strong> ${results.total_posts}</p>
        <p><strong>Average Engagement:</strong> ${results.analysis.avg_engagement.toFixed(1)}</p>
        <p><strong>Total Likes:</strong> ${results.analysis.total_likes.toLocaleString()}</p>
        <p><strong>Total Replies:</strong> ${results.analysis.total_replies.toLocaleString()}</p>
        <p><strong>Total Reposts:</strong> ${results.analysis.total_reposts.toLocaleString()}</p>
        
        <div class="mt-3">
            <h6>Top Posts by Engagement</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Text</th>
                            <th>Likes</th>
                            <th>Replies</th>
                            <th>Reposts</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.ranked_posts.slice(0, 10).map((post, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${post.text.length > 50 ? post.text.substring(0, 50) + '...' : post.text}</td>
                                <td>${post.like_count}</td>
                                <td>${post.reply_count}</td>
                                <td>${post.repost_count}</td>
                                <td><strong>${post.total_engagement}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('results-section').style.display = 'block';
}

function displayContentResults(results) {
    const resultsDiv = document.getElementById('analysis-results');
    let content = '<h6>Content Analysis Results</h6>';
    
    if (results.analyses.vibe && results.analyses.vibe.success) {
        const vibe = results.analyses.vibe.analysis;
        content += `
            <div class="mb-3">
                <h6>Vibe Analysis</h6>
                <p><strong>Tone:</strong> ${vibe.tone || 'N/A'}</p>
                <p><strong>Themes:</strong> ${vibe.themes ? vibe.themes.join(', ') : 'N/A'}</p>
                <p><strong>Vibe Summary:</strong> ${vibe.vibe_summary || 'N/A'}</p>
            </div>
        `;
    }
    
    if (results.analyses.sentiment && results.analyses.sentiment.success) {
        const sentiment = results.analyses.sentiment.sentiment;
        content += `
            <div class="mb-3">
                <h6>Sentiment Analysis</h6>
                <p><strong>Overall Tone:</strong> ${sentiment.overall_tone || 'N/A'}</p>
                <p><strong>Emotions:</strong> ${sentiment.emotions ? sentiment.emotions.join(', ') : 'N/A'}</p>
                <p><strong>Confidence:</strong> ${sentiment.confidence || 'N/A'}</p>
            </div>
        `;
    }
    
    if (results.analyses.categorize && results.analyses.categorize.success) {
        const categories = results.analyses.categorize.categories;
        content += `
            <div class="mb-3">
                <h6>Content Categorization</h6>
                <p><strong>Post Types:</strong> ${categories.post_types ? categories.post_types.join(', ') : 'N/A'}</p>
                <p><strong>Topics:</strong> ${categories.topic_categories ? categories.topic_categories.join(', ') : 'N/A'}</p>
                <p><strong>Purposes:</strong> ${categories.purposes ? categories.purposes.join(', ') : 'N/A'}</p>
            </div>
        `;
    }
    
    resultsDiv.innerHTML = content;
    document.getElementById('results-section').style.display = 'block';
}

function showLoadingModal() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
}

function hideLoadingModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) {
        modal.hide();
    }
}

function showError(message) {
    alert('Error: ' + message);
}
</script>
{% endblock %}