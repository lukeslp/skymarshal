{% extends "base.html" %}

{% block title %}Dashboard - Skymarshal{% endblock %}

{% block content %}
<div class="dashboard-container" id="main-content">
    <!-- Overview Section -->
    <section class="overview-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Content Overview</h2>
            <div style="display: flex; gap: 10px;">
                <a href="https://dr.eamer.dev/bluevibes" class="btn btn-outline" target="_blank"
                    style="background: transparent; border: 2px solid #1d4ed8; color: #1d4ed8; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-weight: 600; transition: all 0.3s;"
                    onmouseover="this.style.background='#1d4ed8'; this.style.color='white';"
                    onmouseout="this.style.background='transparent'; this.style.color='#1d4ed8';">
                    ü¶ã Bluevibes
                </a>
                <a href="https://dr.eamer.dev/bluesky/firehose/" class="btn btn-outline" target="_blank"
                    style="background: transparent; border: 2px solid #f59e0b; color: #f59e0b; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-weight: 600; transition: all 0.3s;"
                    onmouseover="this.style.background='#f59e0b'; this.style.color='white';"
                    onmouseout="this.style.background='transparent'; this.style.color='#f59e0b';">
                    üåä Firehose
                </a>
                <a href="https://dr.eamer.dev/bluesky/post-visualizer" class="btn btn-outline" target="_blank"
                    style="background: transparent; border: 2px solid #059669; color: #059669; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-weight: 600; transition: all 0.3s;"
                    onmouseover="this.style.background='#059669'; this.style.color='white';"
                    onmouseout="this.style.background='transparent'; this.style.color='#059669';">
                    üìä Post Visualizer
                </a>
                <a href="{{ url_for('nuke') }}" class="btn btn-danger-outline"
                    style="background: transparent; border: 2px solid #dc2626; color: #dc2626; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-weight: 600; transition: all 0.3s;"
                    onmouseover="this.style.background='#dc2626'; this.style.color='white';"
                    onmouseout="this.style.background='transparent'; this.style.color='#dc2626';">
                    ‚ö†Ô∏è Nuclear Delete
                </a>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-content">
                    <h3>Posts</h3>
                    <p class="stat-value">{{ stats.total_posts }}</p>
                    <p class="stat-detail">Original posts</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üí¨</div>
                <div class="stat-content">
                    <h3>Replies</h3>
                    <p class="stat-value">{{ stats.total_replies }}</p>
                    <p class="stat-detail">Comments/replies</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">‚ù§Ô∏è</div>
                <div class="stat-content">
                    <h3>Likes Given</h3>
                    <p class="stat-value">{{ stats.total_likes }}</p>
                    <p class="stat-detail">Your like actions</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üîÑ</div>
                <div class="stat-content">
                    <h3>Reposts Given</h3>
                    <p class="stat-value">{{ stats.total_reposts }}</p>
                    <p class="stat-detail">Your repost actions</p>
                </div>
            </div>
        </div>

        <!-- Engagement Received Section -->
        <div class="engagement-received-section">
            <h3>Engagement Received (on your posts/replies)</h3>
            <div class="stats-grid">
                <div class="stat-card engagement">
                    <div class="stat-icon">‚ù§Ô∏è</div>
                    <div class="stat-content">
                        <h4>Likes Received</h4>
                        <p class="stat-value">{{ stats.engagement_stats.total_likes_received }}</p>
                        <p class="stat-detail">Avg: {{ stats.engagement_stats.avg_likes }} per post/reply</p>
                    </div>
                </div>

                <div class="stat-card engagement">
                    <div class="stat-icon">üîÑ</div>
                    <div class="stat-content">
                        <h4>Reposts Received</h4>
                        <p class="stat-value">{{ stats.engagement_stats.total_reposts_received }}</p>
                        <p class="stat-detail">On your content</p>
                    </div>
                </div>

                <div class="stat-card engagement">
                    <div class="stat-icon">üí¨</div>
                    <div class="stat-content">
                        <h4>Replies Received</h4>
                        <p class="stat-value">{{ stats.engagement_stats.total_replies_received }}</p>
                        <p class="stat-detail">On your content</p>
                    </div>
                </div>

                <div class="stat-card engagement highlight">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <h4>Total Engagement</h4>
                        <p class="stat-value">{{ stats.engagement_stats.total_engagement }}</p>
                        <p class="stat-detail">Avg: {{ stats.engagement_stats.avg_engagement }} per post/reply</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Categories (following stats.py pattern) -->
        <div class="engagement-section">
            <div class="engagement-header">
                <h3>Content Performance Categories</h3>
                <div class="engagement-actions">
                    <button id="refresh-data-btn" class="btn btn-outline btn-sm"
                        title="Refresh page to show latest data">
                        <span class="btn-text">‚Üª Refresh</span>
                    </button>
                </div>
            </div>

            <div class="metrics-grid">
                <div class="metric-card viral">
                    <h4>üöÄ Viral</h4>
                    <p class="metric-value">{{ stats.categories.viral }} posts</p>
                    <p class="metric-label">‚â• 2000 likes</p>
                </div>

                <div class="metric-card banger">
                    <h4>üî• Bangers</h4>
                    <p class="metric-value">{{ stats.categories.bangers }} posts</p>
                    <p class="metric-label">‚â• {{ stats.thresholds.double }} likes</p>
                </div>

                <div class="metric-card mid">
                    <h4>üìà Mid</h4>
                    <p class="metric-value">{{ stats.categories.mid }} posts</p>
                    <p class="metric-label">~ avg ({{ stats.engagement_stats.avg_likes }})</p>
                </div>

                <div class="metric-card bomber">
                    <h4>üí• Bombers</h4>
                    <p class="metric-value">{{ stats.categories.bombers }} posts</p>
                    <p class="metric-label">‚â§ {{ stats.thresholds.half }} likes</p>
                </div>

                <div class="metric-card dead">
                    <h4>üíÄ Dead Threads</h4>
                    <p class="metric-value">{{ stats.categories.dead_threads }} posts</p>
                    <p class="metric-label">0 engagement</p>
                </div>

                <div class="metric-card high-engagement">
                    <h4>‚ö° High Engagement</h4>
                    <p class="metric-value">{{ stats.categories.high_engagement }} posts</p>
                    <p class="metric-label">{{ stats.thresholds.high_engagement }}+ engagement score</p>
                </div>
            </div>

            <div class="engagement-info">
                <p class="info-text">
                    <strong>‚úÖ Engagement Categories:</strong> Content is categorized based on engagement patterns
                    following Skymarshal analytics.
                    Engagement data is automatically hydrated during import to show real-time likes, reposts, and
                    replies.
                </p>
                {% if stats.engagement_stats.total_likes_received == 0 and stats.engagement_stats.total_reposts_received
                == 0 and stats.engagement_stats.total_replies_received == 0 and stats.total_posts > 0 %}
                <p class="info-text" style="color: #e74c3c; margin-top: 10px;">
                    <strong>‚ö†Ô∏è No Engagement Data:</strong> Engagement hydration may have failed during import.
                    Try re-importing your data or check your authentication status.
                </p>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Search Section -->
    <section class="search-section">
        <h2>Search & Filter Content</h2>
        <div class="search-container">
            <form id="search-form" class="search-form" role="search" aria-label="Content search form">
                <div class="search-row">
                    <div class="form-group">
                        <label for="search-keyword">Keyword Search</label>
                        <input type="text" id="search-keyword" placeholder="Search text content..."
                            aria-describedby="search-help" autocomplete="off">
                        <div id="search-help" class="sr-only">Enter keywords to search through your Bluesky content
                        </div>
                    </div>

                    <div class="form-group">
                        <fieldset>
                            <legend>Content Types</legend>
                            <div class="checkbox-group" role="group" aria-labelledby="content-types-legend">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="content-type" value="post" checked
                                        aria-describedby="post-help">
                                    <span>Posts</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="content-type" value="like"
                                        aria-describedby="like-help">
                                    <span>Likes</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="content-type" value="repost"
                                        aria-describedby="repost-help">
                                    <span>Reposts</span>
                                </label>
                            </div>
                        </fieldset>
                    </div>
                </div>

                <div class="search-row">
                    <div class="form-group">
                        <label>Date Range</label>
                        <div class="date-inputs">
                            <input type="date" id="start-date" placeholder="Start date">
                            <span>to</span>
                            <input type="date" id="end-date" placeholder="End date">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Engagement Range</label>
                        <div class="range-inputs">
                            <input type="number" id="min-engagement" placeholder="Min" min="0">
                            <span>to</span>
                            <input type="number" id="max-engagement" placeholder="Max" min="0">
                        </div>
                    </div>
                </div>

                <div class="search-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="has-media">
                            <span>Has Media</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="is-reply">
                            <span>Is Reply</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Search</span>
                        <span class="btn-loading" style="display: none;">
                            <span class="spinner"></span> Searching...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- Results Section -->
    <section class="results-section" id="results-section" style="display: none;">
        <div class="results-header">
            <h3>Search Results</h3>
            <div class="results-actions">
                <button id="select-all-btn" class="btn btn-outline btn-sm">Select All</button>
                <button id="deselect-all-btn" class="btn btn-outline btn-sm">Deselect All</button>
                <button id="delete-selected-btn" class="btn btn-danger btn-sm" disabled>
                    Delete Selected (<span id="selected-count">0</span>)
                </button>
            </div>
        </div>

        <div class="results-info" id="results-info"></div>

        <div class="results-table-container">
            <table class="results-table" id="results-table" role="table" aria-label="Search results">
                <thead>
                    <tr role="row">
                        <th class="checkbox-column" scope="col" aria-label="Select all">
                            <input type="checkbox" id="select-all-checkbox" aria-label="Select all results">
                        </th>
                        <th scope="col">Type</th>
                        <th scope="col">Content</th>
                        <th scope="col">Created</th>
                        <th scope="col">Engagement</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="results-tbody" role="rowgroup">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
        </div>

        <div id="no-results" class="no-results" style="display: none;">
            No results found. Try adjusting your search criteria.
        </div>
    </section>
</div>

<!-- Delete Confirmation Modal -->
</div>


<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete <span id="delete-count"></span> selected items?</p>
        <p class="warning-text">This action cannot be undone.</p>
        <div class="modal-actions">
            <button id="confirm-delete-btn" class="btn btn-danger">Delete</button>
            <button id="cancel-delete-btn" class="btn btn-outline">Cancel</button>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <h3>üîó Share Post</h3>
        <p>Public permalink created! Anyone with this link can view this post.</p>

        <div class="form-group" style="margin: 20px 0;">
            <input type="text" id="share-url-input" readonly
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace;">
        </div>

        <div class="modal-actions">
            <button id="copy-share-btn" class="btn btn-primary">Copy Link</button>
            <button id="close-share-btn" class="btn btn-outline">Close</button>
        </div>
    </div>
</div>

<script>
    // Search functionality
    const searchForm = document.getElementById('search-form');
    const resultsSection = document.getElementById('results-section');
    const resultsTbody = document.getElementById('results-tbody');
    const resultsInfo = document.getElementById('results-info');
    const noResults = document.getElementById('no-results');
    const selectedCount = document.getElementById('selected-count');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');

    let searchResults = [];
    let selectedItems = new Set();

    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const searchBtn = searchForm.querySelector('button[type="submit"]');
        searchBtn.disabled = true;
        searchBtn.querySelector('.btn-text').style.display = 'none';
        searchBtn.querySelector('.btn-loading').style.display = 'inline-flex';

        const formData = {
            keyword: document.getElementById('search-keyword').value,
            content_types: Array.from(document.querySelectorAll('input[name="content-type"]:checked')).map(cb => cb.value),
            start_date: document.getElementById('start-date').value,
            end_date: document.getElementById('end-date').value,
            min_engagement: parseInt(document.getElementById('min-engagement').value) || null,
            max_engagement: parseInt(document.getElementById('max-engagement').value) || null,
            has_media: document.getElementById('has-media').checked,
            is_reply: document.getElementById('is-reply').checked
        };

        try {
            const response = await fetch('{{ url_for("search") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                searchResults = data.results;
                displayResults(data.results, data.total);
                resultsSection.style.display = 'block';
            } else {
                alert('Search failed: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('An error occurred: ' + error.message);
        } finally {
            searchBtn.disabled = false;
            searchBtn.querySelector('.btn-text').style.display = 'inline';
            searchBtn.querySelector('.btn-loading').style.display = 'none';
        }
    });

    function displayResults(results, total) {
        selectedItems.clear();
        updateSelectedCount();

        if (results.length === 0) {
            resultsTbody.innerHTML = '';
            noResults.style.display = 'block';
            resultsInfo.style.display = 'none';
            return;
        }

        noResults.style.display = 'none';
        resultsInfo.style.display = 'block';
        resultsInfo.textContent = `Showing ${results.length} of ${total} results`;

        displayResultsRows(results);
    }

    function displayResultsRows(items) {
        resultsTbody.innerHTML = '';

        items.forEach((item) => {
            const row = document.createElement('tr');
            row.dataset.uri = item.uri;

            const textContent = item.text ? escapeHtml(item.text) : '';
            const hasMedia = item.has_media ? '<span class="media-indicator">üì∑</span>' : '';
            const highScore = item.engagement_score > 10 ? 'high-score' : item.engagement_score > 5 ? 'medium-score' : 'low-score';

            row.innerHTML = `
            <td class="checkbox-column">
                <input type="checkbox" class="item-checkbox" data-uri="${item.uri}">
            </td>
            <td>
                <span class="content-type-badge ${item.content_type}">${item.content_type}</span>
            </td>
            <td class="content-cell">
                <div class="content-preview">${textContent}</div>
                ${hasMedia}
            </td>
            <td class="date-cell">
                ${formatDate(item.created_at)}
            </td>
            <td class="engagement-cell">
                <div class="engagement-stats">
                    <span class="engagement-item ${item.likes > 0 ? 'has-engagement' : ''}">
                        <span class="engagement-icon">‚ù§Ô∏è</span>
                        <span class="engagement-count">${item.likes}</span>
                    </span>
                    <span class="engagement-item ${item.reposts > 0 ? 'has-engagement' : ''}">
                        <span class="engagement-icon">üîÑ</span>
                        <span class="engagement-count">${item.reposts}</span>
                    </span>
                    <span class="engagement-item ${item.replies > 0 ? 'has-engagement' : ''}">
                        <span class="engagement-icon">üí¨</span>
                        <span class="engagement-count">${item.replies}</span>
                    </span>
                </div>
                <div class="engagement-score">
                    <span class="score-label">Score:</span>
                    <span class="score-value ${highScore}">${item.engagement_score}</span>
                </div>
            </td>
            <td class="actions-cell">
                <button class="btn btn-outline btn-sm share-btn" style="margin-right: 5px;">Share</button>
                <button class="btn btn-danger btn-sm delete-single" data-uri="${item.uri}">Delete</button>
            </td>
        `;

            // Attach data to share button safely
            const shareBtn = row.querySelector('.share-btn');
            if (shareBtn) {
                shareBtn.dataset.json = JSON.stringify(item);
            }

            resultsTbody.appendChild(row);
        });

        // Add event listeners (re-attach since we rebuilt DOM)
        document.querySelectorAll('.item-checkbox').forEach(cb => {
            cb.addEventListener('change', handleItemSelection);
        });

        document.querySelectorAll('.delete-single').forEach(btn => {
            btn.addEventListener('click', handleSingleDelete);
        });

        document.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', handleSharePost);
        });
    }

    // Selection handling
    function handleItemSelection(e) {
        const uri = e.target.dataset.uri;
        if (e.target.checked) {
            selectedItems.add(uri);
        } else {
            selectedItems.delete(uri);
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        selectedCount.textContent = selectedItems.size;
        deleteSelectedBtn.disabled = selectedItems.size === 0;

        // Update select all checkbox
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const allCheckboxes = document.querySelectorAll('.item-checkbox');
        selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedItems.size === allCheckboxes.length;
    }

    // Select/Deselect all
    document.getElementById('select-all-btn').addEventListener('click', () => {
        document.querySelectorAll('.item-checkbox').forEach(cb => {
            cb.checked = true;
            selectedItems.add(cb.dataset.uri);
        });
        updateSelectedCount();
    });

    document.getElementById('deselect-all-btn').addEventListener('click', () => {
        document.querySelectorAll('.item-checkbox').forEach(cb => {
            cb.checked = false;
        });
        selectedItems.clear();
        updateSelectedCount();
    });

    document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
        document.querySelectorAll('.item-checkbox').forEach(cb => {
            cb.checked = e.target.checked;
            if (e.target.checked) {
                selectedItems.add(cb.dataset.uri);
            } else {
                selectedItems.delete(cb.dataset.uri);
            }
        });
        updateSelectedCount();
    });

    // Delete handling
    deleteSelectedBtn.addEventListener('click', () => {
        document.getElementById('delete-count').textContent = selectedItems.size;
        document.getElementById('delete-modal').style.display = 'flex';
    });

    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
        const btn = document.getElementById('confirm-delete-btn');
        btn.disabled = true;
        btn.textContent = 'Deleting...';

        try {
            const response = await fetch('{{ url_for("delete") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ uris: Array.from(selectedItems) })
            });

            const data = await response.json();

            if (data.success) {
                alert(`Deleted ${data.deleted} items. ${data.failed} failed.`);
                document.getElementById('delete-modal').style.display = 'none';

                // Remove deleted items from the table
                selectedItems.forEach(uri => {
                    const row = document.querySelector(`tr[data-uri="${uri}"]`);
                    if (row) row.remove();
                });

                selectedItems.clear();
                updateSelectedCount();
            } else {
                alert('Deletion failed: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('An error occurred: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Delete';
        }
    });

    document.getElementById('cancel-delete-btn').addEventListener('click', () => {
        document.getElementById('delete-modal').style.display = 'none';
    });

    async function handleSingleDelete(e) {
        const uri = e.target.dataset.uri;
        if (confirm('Are you sure you want to delete this item?')) {
            e.target.disabled = true;
            e.target.textContent = 'Deleting...';

            try {
                const response = await fetch('{{ url_for("delete") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ uris: [uri] })
                });

                const data = await response.json();

                if (data.success && data.deleted > 0) {
                    const row = document.querySelector(`tr[data-uri="${uri}"]`);
                    if (row) row.remove();
                    selectedItems.delete(uri);
                    updateSelectedCount();
                } else {
                    alert('Failed to delete item');
                    e.target.disabled = false;
                    e.target.textContent = 'Delete';
                }
            } catch (error) {
                alert('An error occurred: ' + error.message);
                e.target.disabled = false;
                e.target.textContent = 'Delete';
            }
        }
    }

    // Page initialization
    document.addEventListener('DOMContentLoaded', () => {
        // Check the engagement received statistics to see if engagement data is available
        const likesReceived = parseInt(document.querySelector('.engagement-received-section .stat-card:nth-child(1) .stat-value')?.textContent) || 0;
        const repostsReceived = parseInt(document.querySelector('.engagement-received-section .stat-card:nth-child(2) .stat-value')?.textContent) || 0;
        const repliesReceived = parseInt(document.querySelector('.engagement-received-section .stat-card:nth-child(3) .stat-value')?.textContent) || 0;

        if (likesReceived === 0 && repostsReceived === 0 && repliesReceived === 0) {
            // Check if there are any posts
            const totalPosts = parseInt(document.querySelector('.stats-grid .stat-card:nth-child(1) .stat-value')?.textContent) || 0;

            if (totalPosts > 0) {
                // Update info text to indicate engagement hydration happens during processing
                const infoText = document.querySelector('.engagement-info .info-text');
                infoText.innerHTML = '<strong>‚ÑπÔ∏è No Engagement Data:</strong> Your posts don\'t show engagement data yet. When processing your next CAR file, engagement data will be automatically fetched during the import process.';
            } else {
                // No posts found
                const infoText = document.querySelector('.engagement-info .info-text');
                infoText.innerHTML = '<strong>‚ÑπÔ∏è No Posts Found:</strong> No posts were found in your data. Make sure you processed posts when importing your CAR file data.';
            }
        }
    });

    // Refresh button functionality
    document.getElementById('refresh-data-btn').addEventListener('click', () => {
        window.location.reload();
    });

    // Share functionality
    async function handleSharePost(e) {
        const btn = e.target;
        const originalText = btn.textContent;
        btn.textContent = '‚è≥';
        btn.disabled = true;

        try {
            const itemData = JSON.parse(btn.dataset.json);

            // Prepare payload for sharing API
            const payload = {
                uri: itemData.uri,
                text: itemData.text,
                content_type: itemData.content_type,
                created_at: itemData.created_at,
                likes: itemData.likes,
                reposts: itemData.reposts,
                replies: itemData.replies,
                author: '{{ session["user_handle"] }}' // Use server-side session handle
            };

            const response = await fetch('{{ url_for("share_post") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.success) {
                const shareModal = document.getElementById('share-modal');
                const shareInput = document.getElementById('share-url-input');
                const closeShare = document.getElementById('close-share-btn');
                const copyShare = document.getElementById('copy-share-btn');

                shareInput.value = data.share_url;
                shareModal.style.display = 'flex';

                // Auto-select text
                shareInput.select();

                closeShare.onclick = () => { shareModal.style.display = 'none'; };

                copyShare.onclick = () => {
                    shareInput.select();
                    document.execCommand('copy');
                    copyShare.textContent = 'Copied!';
                    setTimeout(() => copyShare.textContent = 'Copy Link', 2000);
                };

                // Close on background click
                shareModal.onclick = (event) => {
                    if (event.target === shareModal) shareModal.style.display = 'none';
                };
            } else {
                alert('Share failed: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Share error:', error);
            alert('An error occurred while sharing.');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    // Utility functions are defined in main.js
</script>
{% endblock %}