<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Skymarshal Lite</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lite.css') }}">
</head>
<body style="background: var(--bg); margin: 0; padding: 24px;">
    <div style="max-width: 1400px; margin: 0 auto;">
        <header class="lite-header">
            <div class="lite-header-info">
                <h1>üöÄ Skymarshal Lite</h1>
                <p class="lite-tagline">Lightweight Bluesky content manager</p>
            </div>
            <div class="lite-header-actions">
                <span class="lite-handle">@{{ handle }}</span>
                <form method="post" action="{{ url_for('lite_refresh') }}" id="refresh-form" style="margin: 0;">
                    <button type="submit" class="lite-secondary lite-small">üîÑ Refresh</button>
                </form>
                <a href="{{ url_for('lite_logout') }}" class="lite-link">Logout ‚Üí</a>
            </div>
        </header>

        {% if session.password_warning %}
        <div class="lite-warning" style="margin-bottom: 24px;">
            {{ session.password_warning }}
        </div>
        {% endif %}

        {% if error %}
        <div class="lite-warning" style="margin-bottom: 24px;">
            {{ error }}
        </div>
        {% endif %}

        <main style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; align-items: start;">
        <div style="display: flex; flex-direction: column; gap: 16px;">
        <section class="lite-card" style="padding: 16px;">
            <h2 style="margin: 0 0 12px 0; font-size: 16px;">Your Content</h2>
            <div class="lite-summary" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                <div class="lite-summary-item">
                    <span class="lite-summary-value" id="summary-posts" style="font-size: 24px; font-weight: 700;">{{ summary.posts }}</span>
                    <span class="lite-summary-label">Posts</span>
                </div>
                <div class="lite-summary-item">
                    <span class="lite-summary-value" id="summary-replies" style="font-size: 24px; font-weight: 700;">{{ summary.replies }}</span>
                    <span class="lite-summary-label">Replies</span>
                </div>
            </div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); text-align: center;">
                <span style="font-size: 13px; color: var(--text-muted);">
                    <strong id="summary-total">{{ summary.total }}</strong> items loaded
                    <br>
                    <span style="font-size: 11px; opacity: 0.8;">
                        ({{ summary.likes }} likes, {{ summary.reposts }} reposts also available)
                    </span>
                </span>
            </div>
        </section>

        <section class="lite-card" style="padding: 16px;">
            <h2 style="margin: 0 0 12px 0; font-size: 16px;">Export Data</h2>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <a href="{{ url_for('lite_export_csv') }}" class="lite-button" style="text-align: center; text-decoration: none;">
                    üìä Download CSV Export
                </a>
                <a href="{{ url_for('lite_export_car') }}" class="lite-button lite-secondary" style="text-align: center; text-decoration: none;">
                    üíæ Download CAR Backup
                </a>
            </div>
            <p style="margin: 12px 0 0 0; font-size: 12px; color: var(--text-muted);">
                CSV includes all posts, likes, and reposts with engagement data. CAR is a full Bluesky account backup.
            </p>
        </section>

        <section class="lite-card" style="padding: 16px;">
            <h2 style="margin: 0 0 12px 0; font-size: 16px;">Analytics</h2>
            <button id="load-analytics-btn" class="lite-button" style="width: 100%; text-align: center;">
                üìà View Analytics & Insights
            </button>
            <p style="margin: 12px 0 0 0; font-size: 12px; color: var(--text-muted);">
                Sentiment analysis, time patterns, engagement trends, and word frequency
            </p>
        </section>

        <section class="lite-card">
            <h2>Search Posts</h2>
            <form id="search-form" class="lite-grid" role="search" aria-label="Content search form">
                <label class="lite-field">
                    <span>Keyword</span>
                    <input class="lite-input" name="keyword" type="text" placeholder="Search text">
                </label>
                <label class="lite-field">
                    <span>Start Date</span>
                    <input class="lite-input" name="start_date" type="date">
                </label>
                <label class="lite-field">
                    <span>End Date</span>
                    <input class="lite-input" name="end_date" type="date">
                </label>
                <label class="lite-field">
                    <span>Min Engagement</span>
                    <input class="lite-input" name="min_engagement" type="number" min="0">
                </label>
                <label class="lite-field">
                    <span>Max Engagement</span>
                    <input class="lite-input" name="max_engagement" type="number" min="0">
                </label>
                <label class="lite-field">
                    <span>Content Types</span>
                    <select class="lite-input" name="content_types" multiple>
                        <option value="post" selected>Posts</option>
                        <option value="reply">Replies</option>
                        <option value="repost">Reposts</option>
                        <option value="like">Likes</option>
                    </select>
                </label>
                <div class="lite-field full">
                    <button type="submit" class="lite-button">Search</button>
                </div>
            </form>
        </section>
        </div>

        <section class="lite-card" style="min-height: 600px;">
            <div class="lite-results-header">
                <h2>Results</h2>
                <div class="lite-results-actions">
                    <button id="select-all" class="lite-secondary" type="button">Select All</button>
                    <button id="clear-all" class="lite-secondary" type="button">Clear</button>
                    <button id="delete-selected" class="lite-danger" type="button" disabled>Delete Selected</button>
                </div>
            </div>
            <p id="results-meta" class="lite-meta">Search to see results.</p>
            <div class="lite-table-wrapper">
                <table class="lite-table" role="table" aria-label="Search results">
                    <thead>
                        <tr role="row">
                            <th scope="col" aria-label="Select"></th>
                            <th scope="col">Type</th>
                            <th scope="col">Text</th>
                            <th scope="col">Date</th>
                            <th scope="col">Engagement</th>
                            <th scope="col" aria-label="Actions"></th>
                        </tr>
                    </thead>
                    <tbody id="results-body" role="rowgroup"></tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Analytics Modal -->
    <div id="analytics-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
        <div style="max-width: 1200px; margin: 40px auto; padding: 24px;">
            <div class="lite-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h1 style="margin: 0; font-size: 24px;">üìà Analytics & Insights</h1>
                    <button id="close-analytics-btn" class="lite-secondary lite-small">Close</button>
                </div>

                <div id="analytics-loading" style="text-align: center; padding: 40px;">
                    <p style="font-size: 16px; color: var(--text-muted);">Loading analytics...</p>
                </div>

                <div id="analytics-content" style="display: none;">
                    <!-- Sentiment Analysis -->
                    <section class="lite-card" style="margin-bottom: 24px; background: var(--bg-elevated);">
                        <h2 style="margin: 0 0 16px 0; font-size: 18px; color: var(--primary-light);">üòä Sentiment Analysis</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div style="text-align: center;">
                                <div id="sentiment-score" style="font-size: 32px; font-weight: 700; color: var(--primary-light);">0.0</div>
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Average Score</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="sentiment-positive" style="font-size: 32px; font-weight: 700; color: #10b981;">0%</div>
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Positive</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="sentiment-neutral" style="font-size: 32px; font-weight: 700; color: var(--text-muted);">0%</div>
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Neutral</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="sentiment-negative" style="font-size: 32px; font-weight: 700; color: #ef4444;">0%</div>
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Negative</div>
                            </div>
                        </div>
                    </section>

                    <!-- Time Patterns -->
                    <section class="lite-card" style="margin-bottom: 24px; background: var(--bg-elevated);">
                        <h2 style="margin: 0 0 16px 0; font-size: 18px; color: var(--primary-light);">‚è∞ Time Patterns</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <h3 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted);">Best Time to Post</h3>
                                <div id="best-hour" style="font-size: 24px; font-weight: 600; color: var(--primary-light);">--</div>
                                <div id="best-day" style="font-size: 18px; color: var(--text);">--</div>
                            </div>
                            <div>
                                <h3 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted);">Posting Activity</h3>
                                <div id="time-stats" style="font-size: 14px; color: var(--text);"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Engagement Correlation -->
                    <section class="lite-card" style="margin-bottom: 24px; background: var(--bg-elevated);">
                        <h2 style="margin: 0 0 16px 0; font-size: 18px; color: var(--primary-light);">üî• High-Engagement Topics</h2>
                        <div id="engagement-words" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px;">
                        </div>
                    </section>

                    <!-- Word Frequency -->
                    <section class="lite-card" style="background: var(--bg-elevated);">
                        <h2 style="margin: 0 0 16px 0; font-size: 18px; color: var(--primary-light);">üìù Most Used Words</h2>
                        <div id="word-frequency" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;">
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script>
    const searchForm = document.getElementById('search-form');
    const resultsBody = document.getElementById('results-body');
    const resultsMeta = document.getElementById('results-meta');
    const deleteSelected = document.getElementById('delete-selected');
    const selectAll = document.getElementById('select-all');
    const clearAll = document.getElementById('clear-all');
    const refreshForm = document.getElementById('refresh-form');
    const selected = new Set();

    refreshForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        deleteSelected.disabled = true;
        selected.clear();
        resultsMeta.textContent = '‚è≥ Refreshing data from Bluesky...';
        const response = await fetch('{{ url_for('lite_refresh') }}', { method: 'POST' });
        if (!response.ok) {
            resultsMeta.textContent = 'Refresh failed. Try again later.';
            return;
        }
        const data = await response.json();
        if (data.success) {
            // Update overview numbers
            if (data.summary) {
                document.getElementById('summary-posts').textContent = data.summary.posts;
                document.getElementById('summary-replies').textContent = data.summary.replies;
                document.getElementById('summary-total').textContent = data.summary.total;
            }
            resultsMeta.textContent = 'Data refreshed! Run a search to view updated posts.';
        } else {
            resultsMeta.textContent = data.error || 'Refresh failed.';
        }
    });

    function buildPayload(formData) {
        const payload = Object.fromEntries(formData.entries());
        const types = formData.getAll('content_types');
        payload.content_types = types;
        return payload;
    }

    function escapeHtml(value) {
        if (typeof value !== 'string') {
            return value === undefined || value === null ? '' : String(value);
        }
        return value
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function renderResults(items, total) {
        resultsBody.innerHTML = '';
        selected.clear();
        deleteSelected.disabled = true;
        if (!items.length) {
            resultsMeta.textContent = 'No results. Adjust filters and try again.';
            return;
        }
        resultsMeta.textContent = `Showing ${items.length} of ${total}`;
        items.forEach((item) => {
            const row = document.createElement('tr');
            row.dataset.uri = item.uri;
            const textContent = item.text ? escapeHtml(item.text) : 'No text';
            const contentType = escapeHtml(item.content_type);
            const createdAt = item.created_at ? escapeHtml(item.created_at) : '';
            const likes = escapeHtml(item.likes);
            const reposts = escapeHtml(item.reposts);
            const replies = escapeHtml(item.replies);
            const score = escapeHtml(item.engagement_score);
            const uriAttr = escapeHtml(item.uri);
            row.innerHTML = `
                <td><input type="checkbox" class="result-select"></td>
                <td><span class="lite-chip">${contentType}</span></td>
                <td class="lite-text">${textContent}</td>
                <td>${createdAt}</td>
                <td>
                    <span class="lite-pill">‚ù§Ô∏è ${likes}</span>
                    <span class="lite-pill">üîÑ ${reposts}</span>
                    <span class="lite-pill">üí¨ ${replies}</span>
                    <span class="lite-pill">‚ö° ${score}</span>
                </td>
                <td>
                    <button type="button" class="lite-danger lite-small" data-uri="${uriAttr}">Delete</button>
                </td>
            `;
            resultsBody.appendChild(row);
        });
    }

    searchForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        // Show loading state
        const submitBtn = searchForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Loading...';
        
        resultsMeta.textContent = '‚è≥ Loading data from Bluesky... This may take a moment for large accounts.';
        resultsBody.innerHTML = '';

        try {
            const formData = new FormData(searchForm);
            const payload = buildPayload(formData);
            const response = await fetch('{{ url_for('lite_search') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'Search failed');
            }

            // Update overview numbers if summary is included
            if (data.summary) {
                document.getElementById('summary-posts').textContent = data.summary.posts;
                document.getElementById('summary-replies').textContent = data.summary.replies;
                document.getElementById('summary-total').textContent = data.summary.total;
            }

            renderResults(data.results, data.total);
        } catch (error) {
            console.error('Search error:', error);
            resultsMeta.textContent = `‚ùå Error: ${error.message}`;
            resultsBody.innerHTML = '';
        } finally {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });

    resultsBody.addEventListener('change', (event) => {
        if (!event.target.classList.contains('result-select')) {
            return;
        }
        const row = event.target.closest('tr');
        if (!row) {
            return;
        }
        const uri = row.dataset.uri;
        if (!uri) {
            return;
        }
        if (event.target.checked) {
            selected.add(uri);
        } else {
            selected.delete(uri);
        }
        deleteSelected.disabled = selected.size === 0;
    });

    resultsBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button');
        if (!button || !button.dataset.uri) {
            return;
        }
        const uri = button.dataset.uri;
        
        if (!confirm('Are you sure you want to delete this item?')) {
            return;
        }
        
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '‚è≥ Deleting...';
        
        try {
            const response = await fetch('{{ url_for('lite_delete') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uris: [uri] })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            if (data.success && data.deleted) {
                const row = button.closest('tr');
                if (row) {
                    row.remove();
                }
                selected.delete(uri);
                resultsMeta.textContent = `‚úÖ Deleted ${data.deleted} item(s) successfully`;
            } else {
                throw new Error(data.error || 'Delete failed');
            }
        } catch (error) {
            console.error('Delete error:', error);
            resultsMeta.textContent = `‚ùå Delete failed: ${error.message}`;
            button.disabled = false;
            button.textContent = originalText;
        }
        
        deleteSelected.disabled = selected.size === 0;
    });

    deleteSelected.addEventListener('click', async () => {
        if (!selected.size) {
            return;
        }
        
        if (!confirm(`Are you sure you want to delete ${selected.size} selected item(s)?`)) {
            return;
        }
        
        const originalText = deleteSelected.textContent;
        deleteSelected.disabled = true;
        deleteSelected.textContent = `‚è≥ Deleting ${selected.size} items...`;
        
        try {
            const response = await fetch('{{ url_for('lite_delete') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uris: Array.from(selected) })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            if (data.success) {
                Array.from(selected).forEach((uri) => {
                    const row = resultsBody.querySelector(`tr[data-uri="${uri}"]`);
                    if (row) {
                        row.remove();
                    }
                });
                selected.clear();
                resultsMeta.textContent = `‚úÖ Deleted ${data.deleted} item(s) successfully. ${data.failed || 0} failed.`;
            } else {
                throw new Error(data.error || 'Bulk delete failed');
            }
        } catch (error) {
            console.error('Bulk delete error:', error);
            resultsMeta.textContent = `‚ùå Bulk delete failed: ${error.message}`;
        } finally {
            deleteSelected.disabled = true;
            deleteSelected.textContent = originalText;
        }
    });

    selectAll.addEventListener('click', () => {
        resultsBody.querySelectorAll('.result-select').forEach((checkbox) => {
            checkbox.checked = true;
            const row = checkbox.closest('tr');
            if (row && row.dataset.uri) {
                selected.add(row.dataset.uri);
            }
        });
        deleteSelected.disabled = selected.size === 0;
    });

    clearAll.addEventListener('click', () => {
        resultsBody.querySelectorAll('.result-select').forEach((checkbox) => {
            checkbox.checked = false;
        });
        selected.clear();
        deleteSelected.disabled = true;
    });

    // Analytics modal functionality
    const analyticsModal = document.getElementById('analytics-modal');
    const loadAnalyticsBtn = document.getElementById('load-analytics-btn');
    const closeAnalyticsBtn = document.getElementById('close-analytics-btn');
    const analyticsLoading = document.getElementById('analytics-loading');
    const analyticsContent = document.getElementById('analytics-content');

    loadAnalyticsBtn.addEventListener('click', async () => {
        analyticsModal.style.display = 'block';
        analyticsLoading.style.display = 'block';
        analyticsContent.style.display = 'none';

        try {
            const response = await fetch('{{ url_for('lite_analytics') }}');
            const data = await response.json();

            if (data.success) {
                displayAnalytics(data.analytics);
                analyticsLoading.style.display = 'none';
                analyticsContent.style.display = 'block';
            } else {
                analyticsLoading.innerHTML = `<p style="color: var(--danger);">Failed to load analytics: ${data.error}</p>`;
            }
        } catch (error) {
            analyticsLoading.innerHTML = `<p style="color: var(--danger);">Error loading analytics: ${error.message}</p>`;
        }
    });

    closeAnalyticsBtn.addEventListener('click', () => {
        analyticsModal.style.display = 'none';
    });

    // Close modal on background click
    analyticsModal.addEventListener('click', (e) => {
        if (e.target === analyticsModal) {
            analyticsModal.style.display = 'none';
        }
    });

    function displayAnalytics(analytics) {
        // Sentiment Analysis
        const sentiment = analytics.sentiment;
        document.getElementById('sentiment-score').textContent = sentiment.average_score.toFixed(2);
        document.getElementById('sentiment-positive').textContent = sentiment.percentage_positive.toFixed(1) + '%';
        document.getElementById('sentiment-neutral').textContent = sentiment.percentage_neutral.toFixed(1) + '%';
        document.getElementById('sentiment-negative').textContent = sentiment.percentage_negative.toFixed(1) + '%';

        // Time Patterns
        const time = analytics.time_patterns;
        if (time.best_hour !== null) {
            const hour = time.best_hour;
            const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            const ampm = hour >= 12 ? 'PM' : 'AM';
            document.getElementById('best-hour').textContent = `${hour12}:00 ${ampm}`;
        }
        document.getElementById('best-day').textContent = time.best_day || 'N/A';

        // Time stats
        const totalPosts = Object.values(time.by_day_of_week).reduce((a, b) => a + b, 0);
        document.getElementById('time-stats').innerHTML = `
            Total posts analyzed: ${totalPosts}<br>
            Most active hour: ${time.best_hour !== null ? time.best_hour + ':00' : 'N/A'}<br>
            Most active day: ${time.best_day || 'N/A'}
        `;

        // Engagement Correlation
        const engagementWords = document.getElementById('engagement-words');
        engagementWords.innerHTML = '';
        analytics.engagement_correlation.high_engagement_words.slice(0, 15).forEach(word => {
            const chip = document.createElement('div');
            chip.style.cssText = 'background: rgba(59, 130, 246, 0.2); padding: 8px 12px; border-radius: 8px; text-align: center;';
            chip.innerHTML = `
                <div style="font-weight: 600; color: var(--primary-light);">${escapeHtml(word.word)}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${word.avg_engagement} avg engagement</div>
            `;
            engagementWords.appendChild(chip);
        });

        // Word Frequency
        const wordFrequency = document.getElementById('word-frequency');
        wordFrequency.innerHTML = '';
        analytics.word_frequency.top_words.slice(0, 20).forEach(word => {
            const chip = document.createElement('div');
            chip.style.cssText = 'background: var(--bg-card); padding: 8px 12px; border-radius: 8px; text-align: center; border: 1px solid var(--border);';
            chip.innerHTML = `
                <div style="font-weight: 600; color: var(--text);">${escapeHtml(word.word)}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${word.count} times</div>
            `;
            wordFrequency.appendChild(chip);
        });
    }
    </script>
</body>
</html>
