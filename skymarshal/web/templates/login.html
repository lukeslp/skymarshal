{% extends "base.html" %}

{% block title %}Login - Skymarshal{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <h2>Welcome to Skymarshal</h2>
        <p class="auth-subtitle">Sign in with your Bluesky account to manage your content</p>
        
        <form id="login-form" class="auth-form">
            <div class="form-group">
                <label for="handle">Bluesky Handle</label>
                <input type="text" id="handle" name="handle" placeholder="username or username.bsky.social" required>
                <small class="form-hint">Enter your handle without the @ symbol</small>
            </div>
            
            <div class="form-group">
                <label for="password">App Password</label>
                <input type="password" id="password" name="password" required>
                <small class="form-hint">
                    Use an app password from <a href="https://bsky.app/settings/app-passwords" target="_blank" rel="noopener">Bluesky settings</a>
                    <br>‚ö†Ô∏è Do not use your regular Bluesky password
                </small>
            </div>
            
            <div id="error-message" class="error-message" style="display: none;"></div>
            
            <button type="submit" class="btn btn-primary btn-block" id="login-btn">
                <span class="btn-text">Sign In</span>
                <span class="btn-loading" style="display: none;">
                    <span class="spinner"></span> Authenticating...
                </span>
            </button>
        </form>
        
        <div class="auth-footer">
            <p>Your credentials are never stored and are only used to create a temporary session.</p>
        </div>
    </div>
</div>

<script>
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const handle = document.getElementById('handle').value;
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('error-message');
    const loginBtn = document.getElementById('login-btn');
    
    // Show loading state
    loginBtn.disabled = true;
    loginBtn.querySelector('.btn-text').style.display = 'none';
    loginBtn.querySelector('.btn-loading').style.display = 'inline-flex';
    errorDiv.style.display = 'none';
    
    try {
        const response = await fetch('/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ handle, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
            window.location.href = data.redirect;
        } else {
            if (data.suggestion === 'app_password') {
                errorDiv.innerHTML = `
                    ${data.error || 'Login failed'}
                    <br><br>
                    <a href="https://bsky.app/settings/app-passwords" target="_blank" rel="noopener" class="btn-link">
                        üîó Create App Password in Bluesky Settings
                    </a>
                `;
            } else {
                errorDiv.textContent = data.error || 'Login failed';
            }
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.style.display = 'block';
    } finally {
        loginBtn.disabled = false;
        loginBtn.querySelector('.btn-text').style.display = 'inline';
        loginBtn.querySelector('.btn-loading').style.display = 'none';
    }
});
</script>
{% endblock %}