{% extends "base.html" %}

{% block title %}Setup - Skymarshal{% endblock %}

{% block content %}
<div class="setup-container">
    <div class="setup-header">
        <h2>Welcome, @{{ handle }}!</h2>
        <p>Let's download your Bluesky data and get started.</p>
    </div>
    
    <div class="setup-steps">
        <!-- Step 1: Download CAR -->
        <div class="step-card" id="step-download">
            <div class="step-header">
                <h3>Step 1: Download Your Data</h3>
                <span class="step-status" id="download-status"></span>
            </div>
            <div class="step-content">
                <p>First, we'll download your complete Bluesky archive (CAR file). This contains all your posts, likes, and reposts.</p>
                <button id="download-btn" class="btn btn-primary btn-center">
                    <span class="btn-text">Start Download</span>
                    <span class="btn-loading" style="display: none;">
                        <span class="spinner"></span> Downloading...
                    </span>
                </button>
                <div class="progress-container" id="download-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="download-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="download-progress-text">0%</div>
                </div>
                <div class="step-message" id="download-message"></div>
                
                <!-- Bluesky Firehose -->
                <div class="firehose-container" id="firehose-container" style="display: none;">
                    <div class="firehose-header">
                        <h4>🔥 Live Bluesky Firehose</h4>
                        <small>Real-time posts from across the network</small>
                    </div>
                    <div class="firehose-stream" id="firehose-stream">
                        <!-- Live messages will appear here -->
                    </div>
                </div>
                
                <!-- Stats Carousel -->
                <div class="facts-carousel" id="facts-carousel" style="display: none;">
                    <div class="fact-display" id="fact-display">
                        <div class="fact-icon" id="fact-icon">📊</div>
                        <div class="fact-content">
                            <div class="fact-title" id="fact-title">Loading...</div>
                            <div class="fact-value" id="fact-value">Please wait</div>
                            <div class="fact-description" id="fact-description">Loading stats...</div>
                        </div>
                    </div>
                    <div class="fact-indicator" id="fact-indicator">
                        <span class="fact-dot active"></span>
                    </div>
                </div>
                
                <!-- Quick Stats from CAR -->
                <div class="car-stats" id="car-stats" style="display: none;">
                    <h4>📊 Content Overview</h4>
                    <div class="stats-grid" id="stats-grid">
                        <!-- Stats will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Select Content -->
        <div class="step-card collapsed" id="step-select">
            <div class="step-header">
                <h3>Step 2: Choose What to Analyze</h3>
                <span class="step-status" id="select-status"></span>
            </div>
            <div class="step-content" style="display: none;">
                <p>Select which types of content you want to analyze:</p>
                
                <div class="content-selector">
                    <div class="content-option">
                        <label class="checkbox-label">
                            <input type="checkbox" id="select-posts" value="posts" checked>
                            <span>Posts</span>
                        </label>
                        <div class="limit-input">
                            <label>Limit (0 = all):</label>
                            <input type="number" id="limit-posts" min="0" value="0" placeholder="0">
                        </div>
                    </div>
                    
                    <div class="content-option">
                        <label class="checkbox-label">
                            <input type="checkbox" id="select-likes" value="likes">
                            <span>Likes</span>
                        </label>
                        <div class="limit-input">
                            <label>Limit (0 = all):</label>
                            <input type="number" id="limit-likes" min="0" value="0" placeholder="0">
                        </div>
                    </div>
                    
                    <div class="content-option">
                        <label class="checkbox-label">
                            <input type="checkbox" id="select-reposts" value="reposts">
                            <span>Reposts</span>
                        </label>
                        <div class="limit-input">
                            <label>Limit (0 = all):</label>
                            <input type="number" id="limit-reposts" min="0" value="0" placeholder="0">
                        </div>
                    </div>
                </div>
                
                <button id="process-btn" class="btn btn-primary btn-center" disabled>
                    <span class="btn-text">Process Selected Content</span>
                    <span class="btn-loading" style="display: none;">
                        <span class="spinner"></span> Processing...
                    </span>
                </button>
                
                <div class="progress-container" id="process-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="process-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="process-progress-text">Processing...</div>
                </div>
                <div class="step-message" id="process-message"></div>
            </div>
        </div>
    </div>
</div>

<script>
let carDownloaded = false;
let factsCarousel = null;
let firehoseStream = null;

// Facts carousel functionality
class FactsCarousel {
    constructor() {
        this.facts = [];
        this.currentIndex = 0;
        this.intervalId = null;
        this.container = document.getElementById('facts-carousel');
    }
    
    async loadFacts() {
        try {
            const response = await fetch('/bluesky-facts');
            const data = await response.json();
            if (data.success && data.facts) {
                this.facts = data.facts;
                this.updateIndicators();
                this.showFact(0);
                return true;
            }
        } catch (error) {
            console.error('Failed to load facts:', error);
        }
        return false;
    }
    
    showFact(index) {
        if (!this.facts || this.facts.length === 0) return;
        
        const fact = this.facts[index];
        document.getElementById('fact-icon').textContent = fact.icon;
        document.getElementById('fact-title').textContent = fact.title;
        document.getElementById('fact-value').textContent = fact.value;
        document.getElementById('fact-description').textContent = fact.description;
        
        // Update indicators
        document.querySelectorAll('.fact-dot').forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
        });
        
        this.currentIndex = index;
    }
    
    updateIndicators() {
        const indicator = document.getElementById('fact-indicator');
        indicator.innerHTML = this.facts.map((_, i) => 
            `<span class="fact-dot ${i === 0 ? 'active' : ''}"></span>`
        ).join('');
    }
    
    start() {
        this.container.style.display = 'block';
        
        if (this.facts.length > 1) {
            this.intervalId = setInterval(() => {
                this.showFact((this.currentIndex + 1) % this.facts.length);
            }, 4000); // Change fact every 4 seconds
        }
    }
    
    stop() {
        if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
        }
        this.container.style.display = 'none';
    }
}

// Firehose functionality
class FirehoseStream {
    constructor() {
        this.container = document.getElementById('firehose-container');
        this.stream = document.getElementById('firehose-stream');
        this.eventSource = null;
        this.maxMessages = 20;
    }
    
    start() {
        this.container.style.display = 'block';
        
        try {
            this.eventSource = new EventSource('/firehose');
            
            this.eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    this.addMessage(data);
                } catch (error) {
                    console.error('Error parsing firehose data:', error);
                }
            };
            
            this.eventSource.onerror = () => {
                console.log('Firehose connection lost, retrying...');
                setTimeout(() => {
                    if (this.eventSource) {
                        this.eventSource.close();
                        this.start();
                    }
                }, 5000);
            };
        } catch (error) {
            console.error('Failed to start firehose:', error);
            // Add some mock messages for demo
            this.addMockMessages();
        }
    }
    
    addMessage(data) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `firehose-message ${data.type}`;
        
        const author = data.author.replace('.bsky.social', '').substring(0, 20);
        const text = data.text.substring(0, 80);
        
        messageDiv.innerHTML = `
            <span class="message-author">@${author}</span>
            <span class="message-text">${text}</span>
        `;
        
        // Add to top of stream
        this.stream.insertBefore(messageDiv, this.stream.firstChild);
        
        // Remove old messages to prevent overflow
        while (this.stream.children.length > this.maxMessages) {
            this.stream.removeChild(this.stream.lastChild);
        }
        
        // Trigger animation
        requestAnimationFrame(() => {
            messageDiv.style.animationDelay = '0s';
        });
    }
    
    addMockMessages() {
        const mockMessages = [
            { type: 'post', author: 'alice.bsky.social', text: 'Beautiful sunset today! 🌅' },
            { type: 'like', author: 'bob.bsky.social', text: '❤️ liked a post' },
            { type: 'repost', author: 'charlie.bsky.social', text: '🔄 reposted' },
            { type: 'post', author: 'diana.bsky.social', text: 'Just finished reading a great book' },
            { type: 'post', author: 'eve.bsky.social', text: 'Coffee break time ☕' }
        ];
        
        let messageIndex = 0;
        const addNextMessage = () => {
            if (this.container.style.display === 'block') {
                this.addMessage(mockMessages[messageIndex % mockMessages.length]);
                messageIndex++;
                setTimeout(addNextMessage, 400 + Math.random() * 600);
            }
        };
        
        setTimeout(addNextMessage, 1000);
    }
    
    stop() {
        if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
        }
        this.container.style.display = 'none';
    }
}

// Handle CAR download
document.getElementById('download-btn').addEventListener('click', async () => {
    const btn = document.getElementById('download-btn');
    const progressContainer = document.getElementById('download-progress');
    const progressFill = document.getElementById('download-progress-fill');
    const progressText = document.getElementById('download-progress-text');
    const messageDiv = document.getElementById('download-message');
    
    btn.disabled = true;
    btn.querySelector('.btn-text').style.display = 'none';
    btn.querySelector('.btn-loading').style.display = 'inline-flex';
    progressContainer.style.display = 'block';
    
    // Start firehose and facts carousel during download
    firehoseStream = new FirehoseStream();
    firehoseStream.start();
    
    factsCarousel = new FactsCarousel();
    await factsCarousel.loadFacts();
    factsCarousel.start();
    
    const eventSource = new EventSource('/download-car');
    
    eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.status === 'starting') {
            progressFill.style.width = '10%';
            progressText.textContent = 'Connecting to Bluesky...';
        } else if (data.status === 'downloading') {
            progressFill.style.width = '25%';
            progressText.textContent = 'Downloading archive...';
        } else if (data.status === 'processing') {
            progressFill.style.width = '60%';
            progressText.textContent = 'Processing CAR file...';
        } else if (data.status === 'analyzing') {
            progressFill.style.width = '85%';
            progressText.textContent = 'Analyzing content...';
        } else if (data.status === 'completed') {
            progressFill.style.width = '100%';
            progressText.textContent = '100% - Download Complete!';
            messageDiv.textContent = 'CAR file downloaded successfully!';
            messageDiv.className = 'step-message success';
            carDownloaded = true;
            eventSource.close();
            
            // Stop firehose and facts carousel
            if (firehoseStream) {
                firehoseStream.stop();
            }
            if (factsCarousel) {
                factsCarousel.stop();
            }
            
            // Show stats if available
            if (data.stats) {
                displayCarStats(data.stats);
            }
            
            // Enable step 2 with animation
            enableStep2();
            
            document.getElementById('download-status').textContent = '✓';
            document.getElementById('download-status').className = 'step-status completed';
        } else if (data.status === 'error') {
            messageDiv.textContent = `Error: ${data.error}`;
            messageDiv.className = 'step-message error';
            eventSource.close();
            btn.disabled = false;
            btn.querySelector('.btn-text').style.display = 'inline';
            btn.querySelector('.btn-loading').style.display = 'none';
        } else if (data.message) {
            messageDiv.textContent = data.message;
            messageDiv.className = 'step-message info';
        }
    };
    
    eventSource.onerror = () => {
        eventSource.close();
        messageDiv.textContent = 'Connection lost. Please try again.';
        messageDiv.className = 'step-message error';
        btn.disabled = false;
        btn.querySelector('.btn-text').style.display = 'inline';
        btn.querySelector('.btn-loading').style.display = 'none';
    };
});

// Handle content processing
document.getElementById('process-btn').addEventListener('click', async () => {
    const btn = document.getElementById('process-btn');
    const progressContainer = document.getElementById('process-progress');
    const progressFill = document.getElementById('process-progress-fill');
    const progressText = document.getElementById('process-progress-text');
    const messageDiv = document.getElementById('process-message');
    
    // Get selected content types and limits
    const contentTypes = [];
    const limits = {};
    
    if (document.getElementById('select-posts').checked) {
        contentTypes.push('posts');
        limits.posts = parseInt(document.getElementById('limit-posts').value) || 0;
    }
    if (document.getElementById('select-likes').checked) {
        contentTypes.push('likes');
        limits.likes = parseInt(document.getElementById('limit-likes').value) || 0;
    }
    if (document.getElementById('select-reposts').checked) {
        contentTypes.push('reposts');
        limits.reposts = parseInt(document.getElementById('limit-reposts').value) || 0;
    }
    
    if (contentTypes.length === 0) {
        messageDiv.textContent = 'Please select at least one content type.';
        messageDiv.className = 'step-message error';
        return;
    }
    
    btn.disabled = true;
    btn.querySelector('.btn-text').style.display = 'none';
    btn.querySelector('.btn-loading').style.display = 'inline-flex';
    progressContainer.style.display = 'block';
    progressFill.style.width = '0%';
    
    // Start firehose and facts carousel during processing if not already running
    if (!firehoseStream) {
        firehoseStream = new FirehoseStream();
    }
    firehoseStream.start();
    
    if (!factsCarousel) {
        factsCarousel = new FactsCarousel();
        await factsCarousel.loadFacts();
    }
    factsCarousel.start();
    
    try {
        const response = await fetch('/process-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content_types: contentTypes, limits: limits })
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n').filter(line => line.startsWith('data: '));
            
            for (const line of lines) {
                try {
                    const data = JSON.parse(line.substring(6));
                    
                    if (data.status === 'processing') {
                        if (data.progress) {
                            progressFill.style.width = `${data.progress}%`;
                            progressText.textContent = `${data.progress}% - ${data.message}`;
                        } else {
                            progressText.textContent = data.message;
                        }
                        messageDiv.textContent = data.message;
                        messageDiv.className = 'step-message info';
                    } else if (data.status === 'filtering') {
                        messageDiv.textContent = data.message;
                        messageDiv.className = 'step-message info';
                        
                        // Show detailed filtering info
                        if (data.count !== undefined) {
                            const filterDetail = document.createElement('div');
                            filterDetail.className = 'filter-detail';
                            filterDetail.style.fontSize = '0.9em';
                            filterDetail.style.color = '#666';
                            filterDetail.style.marginTop = '0.5rem';
                            
                            let detailText = `✓ ${data.type}: ${data.count.toLocaleString()} items`;
                            if (data.original_count && data.original_count !== data.count) {
                                detailText += ` (limited from ${data.original_count.toLocaleString()})`;
                            }
                            filterDetail.textContent = detailText;
                            
                            // Remove previous detail for this type and add new one
                            const existingDetail = messageDiv.querySelector(`.filter-detail[data-type="${data.type}"]`);
                            if (existingDetail) {
                                existingDetail.remove();
                            }
                            filterDetail.setAttribute('data-type', data.type);
                            messageDiv.appendChild(filterDetail);
                        }
                    } else if (data.status === 'finalizing') {
                        progressFill.style.width = `${data.progress || 100}%`;
                        progressText.textContent = data.message;
                        messageDiv.textContent = data.message;
                        messageDiv.className = 'step-message success';
                    } else if (data.status === 'completed') {
                        progressFill.style.width = '100%';
                        progressText.textContent = 'Processing complete!';
                        messageDiv.textContent = `Successfully processed ${data.total_items} items!`;
                        messageDiv.className = 'step-message success';
                        document.getElementById('select-status').textContent = '✓';
                        document.getElementById('select-status').className = 'step-status completed';
                        
                        // Stop firehose and facts carousel
                        if (firehoseStream) {
                            firehoseStream.stop();
                        }
                        if (factsCarousel) {
                            factsCarousel.stop();
                        }
                        
                        // Redirect to dashboard after 2 seconds
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 2000);
                    } else if (data.status === 'error') {
                        throw new Error(data.error);
                    }
                } catch (e) {
                    console.error('Error parsing SSE data:', e);
                }
            }
        }
    } catch (error) {
        messageDiv.textContent = `Error: ${error.message}`;
        messageDiv.className = 'step-message error';
        btn.disabled = false;
        btn.querySelector('.btn-text').style.display = 'inline';
        btn.querySelector('.btn-loading').style.display = 'none';
    }
});

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function enableStep2() {
    const step2 = document.getElementById('step-select');
    const step2Content = step2.querySelector('.step-content');
    
    // Remove collapsed class and show content
    step2.classList.remove('collapsed');
    step2Content.style.display = 'block';
    
    // Add smooth transition
    step2.style.transition = 'opacity 0.3s ease';
    step2.style.opacity = '1';
    
    // Enable the process button
    document.getElementById('process-btn').disabled = false;
    
    // Scroll to step 2
    setTimeout(() => {
        step2.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);
}

function displayCarStats(stats) {
    const carStatsDiv = document.getElementById('car-stats');
    const statsGrid = document.getElementById('stats-grid');
    
    if (!stats) return;
    
    // Create stat items
    const statItems = [
        { label: 'Posts', value: stats.posts || 0, icon: '📝' },
        { label: 'Replies', value: stats.replies || 0, icon: '💬' },
        { label: 'Likes', value: stats.likes || 0, icon: '❤️' },
        { label: 'Reposts', value: stats.reposts || 0, icon: '🔄' }
    ];
    
    // Add total if available
    if (stats.total) {
        statItems.push({ label: 'Total', value: stats.total, icon: '📊' });
    }
    
    // Debug info
    if (stats.debug) {
        console.log('CAR Stats Debug Info:', stats.debug);
    }
    
    if (stats.error) {
        console.error('CAR parsing error:', stats.error);
    }
    
    statsGrid.innerHTML = statItems.map(item => `
        <div class="stat-item">
            <p class="stat-value">${item.icon} ${item.value.toLocaleString()}</p>
            <p class="stat-label">${item.label}</p>
        </div>
    `).join('');
    
    // Show the stats with animation
    carStatsDiv.style.display = 'block';
    carStatsDiv.style.opacity = '0';
    carStatsDiv.style.transform = 'translateY(10px)';
    carStatsDiv.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    
    setTimeout(() => {
        carStatsDiv.style.opacity = '1';
        carStatsDiv.style.transform = 'translateY(0)';
    }, 100);
}
</script>
{% endblock %}